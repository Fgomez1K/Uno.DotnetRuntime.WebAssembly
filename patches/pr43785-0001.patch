From 1095b7fa4867fc2010408a6c1a9bc3f6a01369c7 Mon Sep 17 00:00:00 2001
From: Zoltan Varga <vargaz@gmail.com>
Date: Fri, 23 Oct 2020 16:21:10 -0400
Subject: [PATCH 1/3] Add files need for wasm executable relinking/aot to the
 wasm runtime pack.

---
 eng/liveBuilds.targets  |  5 ++++-
 src/mono/wasm/wasm.proj | 21 +++++++++++++++++++--
 2 files changed, 23 insertions(+), 3 deletions(-)

diff --git a/eng/liveBuilds.targets b/eng/liveBuilds.targets
index f561eb7a9bb..78efc9a42d9 100644
--- a/eng/liveBuilds.targets
+++ b/eng/liveBuilds.targets
@@ -195,7 +195,10 @@
         $(LibrariesNativeArtifactsPath)dotnet.js;
         $(LibrariesNativeArtifactsPath)dotnet.wasm;
         $(LibrariesNativeArtifactsPath)dotnet.timezones.blat;
-        $(LibrariesNativeArtifactsPath)*.dat;"
+        $(LibrariesNativeArtifactsPath)*.dat;
+        $(LibrariesNativeArtifactsPath)*.c;
+        $(LibrariesNativeArtifactsPath)*.h;
+        $(LibrariesNativeArtifactsPath)*.js;"
         IsNative="true" />
     </ItemGroup>
 
diff --git a/src/mono/wasm/wasm.proj b/src/mono/wasm/wasm.proj
index a88c77a4964..7e52be17561 100644
--- a/src/mono/wasm/wasm.proj
+++ b/src/mono/wasm/wasm.proj
@@ -86,12 +86,29 @@
           AfterTargets="Build"
           DependsOnTargets="BuildPInvokeTable;BundleTimeZones">
 
-    <Exec Command="make -C $(MonoProjectRoot)wasm all SHELL=/bin/bash BINDIR=$(ArtifactsBinDir) MONO_BIN_DIR=$(MonoArtifactsPath) OBJDIR=$(ArtifactsObjDir) NATIVE_BIN_DIR=$(NativeBinDir) CONFIG=$(Configuration) PINVOKE_TABLE=$(WasmPInvokeTablePath) ICU_LIBDIR=$(PkgMicrosoft_NETCore_Runtime_ICU_Transport)/runtimes/browser-wasm/native/lib ENABLE_ES6=$(WasmEnableES6)"
+    <PropertyGroup>
+      <_IcuLibdir>$(PkgMicrosoft_NETCore_Runtime_ICU_Transport)/runtimes/browser-wasm/native/lib</_IcuLibdir>
+    </PropertyGroup>
+
+    <Exec Command="make -C $(MonoProjectRoot)wasm all SHELL=/bin/bash BINDIR=$(ArtifactsBinDir) MONO_BIN_DIR=$(MonoArtifactsPath) OBJDIR=$(ArtifactsObjDir) NATIVE_BIN_DIR=$(NativeBinDir) CONFIG=$(Configuration) PINVOKE_TABLE=$(WasmPInvokeTablePath) ICU_LIBDIR=$(_IcuLibdir) ENABLE_ES6=$(WasmEnableES6)"
           IgnoreStandardErrorWarningFormat="true" />
 
     <Copy SourceFiles="$(NativeBinDir)dotnet.js;
                        $(NativeBinDir)dotnet.wasm;
-                       $(NativeBinDir)dotnet.timezones.blat"
+                       $(NativeBinDir)dotnet.timezones.blat;
+                       $(MonoProjectRoot)wasm\runtime\driver.c;
+                       $(MonoProjectRoot)wasm\runtime\pinvoke.c;
+                       $(MonoProjectRoot)wasm\runtime\corebindings.c;
+                       $(MonoProjectRoot)wasm\runtime\pinvoke.h;
+                       $(MonoProjectRoot)wasm\runtime\binding_support.js;
+                       $(MonoProjectRoot)wasm\runtime\dotnet_support.js;
+                       $(MonoProjectRoot)wasm\runtime\library_mono.js;
+                       $(LibrariesProjectRoot)Native\Unix\System.Native\pal_random.js;
+                       $(_IcuLibdir)\libicudata.a;
+                       $(_IcuLibdir)\libicui18n.a;
+                       $(_IcuLibdir)\libicutest.a;
+                       $(_IcuLibdir)\libicutu.a;
+                       $(_IcuLibdir)\libicuuc.a"
           DestinationFolder="$(MicrosoftNetCoreAppRuntimePackNativeDir)"
           SkipUnchangedFiles="true" />
 
-- 
2.17.1

